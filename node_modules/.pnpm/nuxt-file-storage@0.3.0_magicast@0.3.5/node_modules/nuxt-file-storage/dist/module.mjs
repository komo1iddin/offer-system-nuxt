import { defineNuxtModule, logger, createResolver, addImportsDir, addServerScanDir } from '@nuxt/kit';
import defu from 'defu';

const module = defineNuxtModule({
  meta: {
    name: "nuxt-file-storage",
    configKey: "fileStorage"
  },
  //? Default configuration options of the Nuxt module
  //! no defaults for now
  // defaults: {
  // 	version: '0.0.0',
  // },
  setup(options, nuxt) {
    const config = nuxt.options.runtimeConfig;
    config.public.fileStorage = defu(config.public.fileStorage, {
      ...options
    });
    if (!config.public.fileStorage.mount) {
      logger.error(
        "Please provide a mount path for the file storage module in your nuxt.config.js"
      );
    } else {
      logger.ready(
        `Nuxt File Storage has mounted successfully`
      );
    }
    const resolve = createResolver(import.meta.url).resolve;
    addImportsDir(resolve("runtime/composables"));
    addServerScanDir(resolve("./runtime/server"));
  }
});

export { module as default };
